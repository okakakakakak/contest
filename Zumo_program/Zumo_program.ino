/*
 * Zumo_program.ino
 * 
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘
 * Zumoãƒ­ãƒœãƒƒãƒˆã®ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
 * setup()ã¨loop()ã‚’å®Ÿè£…ã—ã€å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ãƒ»å®Ÿè¡Œã™ã‚‹
 * 
 * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘
 * v3.1 - å‚é“æ¤œçŸ¥ãƒ»ç™»å‚æ©Ÿèƒ½ã‚’è¿½åŠ 
 * 
 * ã€ä¸»è¦æ©Ÿèƒ½ã€‘
 * - setup(): ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–ã¨ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 * - loop(): ã‚»ãƒ³ã‚µãƒ¼èª­ã¿å–ã‚Šã¨ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
 */

#include "definitions.h"

// ============================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå®šç¾©
// ============================================
// å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ä½¿ç”¨ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Ÿä½“åŒ–
Pushbutton button(ZUMO_BUTTON);         // ãƒœã‚¿ãƒ³ï¼ˆZumoã®å‰é¢ãƒœã‚¿ãƒ³ï¼‰
MotorController motor_ctrl;             // ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡
ColorSensorState color_sensor;          // ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼
CompassState compass_state;             // åœ°ç£æ°—ã‚»ãƒ³ã‚µãƒ¼ãƒ»åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼
UltrasonicSensor ultrasonic(2, 4);      // è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼ï¼ˆãƒˆãƒªã‚¬ãƒ¼:2, ã‚¨ã‚³ãƒ¼:4ï¼‰
RobotState robot_state;                 // ãƒ­ãƒœãƒƒãƒˆã®çŠ¶æ…‹
PIController pi_ctrl;                   // PIåˆ¶å¾¡

// ============================================
// å®šæ•°å®šç¾©
// ============================================
const float TARGET_HEADING = 210.0;       // ç›®æ¨™æ–¹ä½è§’ï¼ˆåº¦ï¼‰
const float MAGNETIC_DECLINATION = -7.0;  // ç£æ°—åè§’ï¼ˆåº¦ã€åœ°åŸŸã«ã‚ˆã£ã¦ç•°ãªã‚‹ï¼‰
const char ROBOT_NAME[] PROGMEM = "Zumo1";  // â† ãƒ­ãƒœãƒƒãƒˆåï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰

// ============================================
// ãƒœã‚¿ãƒ³å¾…æ©Ÿé–¢æ•°ï¼ˆç°¡ç•¥ç‰ˆï¼‰
// ============================================
/**
 * ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹é–¢æ•°
 * ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å‰ãªã©ã«ä½¿ç”¨
 */
void waitForButtonPress() {
  Serial.println(F("Press button..."));
  
  // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
  while (!button.isPressed()) {
    delay(50);  // 50msé–“éš”ã§ãƒã‚§ãƒƒã‚¯
  }
  
  // ãƒœã‚¿ãƒ³ãŒé›¢ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿï¼ˆãƒãƒ£ã‚¿ãƒªãƒ³ã‚°é˜²æ­¢ï¼‰
  while (button.isPressed()) {
    delay(10);
  }
  
  Serial.println(F("OK!"));
  delay(300);  // å®‰å®šåŒ–ã®ãŸã‚ã®å¾…æ©Ÿ
}

// ============================================
// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// ============================================
/**
 * åˆæœŸåŒ–å‡¦ç†
 * å„ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆæœŸåŒ–ã—ã€ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
 * ã“ã®é–¢æ•°ã¯èµ·å‹•æ™‚ã«1å›ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹
 */
void setup() {
  // ========================================
  // ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã®åˆæœŸåŒ–
  // ========================================
  // 9600bpsã§åˆæœŸåŒ–ï¼ˆã“ã‚Œã‚ˆã‚Šé€Ÿã„ã¨èªè­˜ã—ãªã„ã‹ã‚‚ï¼‰
  Serial.begin(9600);
  delay(1500);  // ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã®å®‰å®šåŒ–ã‚’å¾…ã¤

  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
  Serial.println(F("\n=== Zumo v3.1 ==="));
  
  // ========================================
  // ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–
  // ========================================
  Serial.print(F("Color sensor..."));
  if (color_sensor.tcs.begin()) {
    // åˆæœŸåŒ–æˆåŠŸ
    Serial.println(F("OK"));
  } else {
    // åˆæœŸåŒ–å¤±æ•—ï¼šåœæ­¢
    Serial.println(F("FAIL"));
    while (1) delay(1000);  // ç„¡é™ãƒ«ãƒ¼ãƒ—ã§åœæ­¢
  }
  
  // ========================================
  // åœ°ç£æ°—ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–
  // ========================================
  Serial.print(F("Compass..."));
  compass_state.compass.init();           // ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆæœŸåŒ–
  compass_state.compass.enableDefault();  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’æœ‰åŠ¹åŒ–ï¼ˆåŠ é€Ÿåº¦è¨ˆã‚‚æœ‰åŠ¹ï¼‰
  
  // åˆæœŸã®æœ€å°å€¤ãƒ»æœ€å¤§å€¤ã‚’è¨­å®šï¼ˆå¾Œã§ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ›´æ–°ï¼‰
  compass_state.compass.m_min.x = -32767;
  compass_state.compass.m_min.y = -32767;
  compass_state.compass.m_max.x = 32767;
  compass_state.compass.m_max.y = 32767;
  Serial.println(F("OK"));
  
  // ========================================
  // è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–
  // ========================================
  Serial.print(F("Ultrasonic..."));
  ultrasonic.init();  // ãƒ”ãƒ³ã‚’è¨­å®š
  Serial.println(F("OK"));

    // ========================================
  // ã‚´ãƒ¼ãƒ«è‰²ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å—ä¿¡
  // ========================================
  Serial.println(F("--- Requesting Goal Color ---"));
  Serial.println("REQUEST_COLOR");  // Processingã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡

  unsigned long startTime = millis();
  while (!Serial.available()) {
    if (millis() - startTime > 3000) {
      Serial.println(F("Timeout: No color response"));
      break;
    }
    delay(10);
  }

  if (Serial.available()) {
    char c = Serial.read();
    if (c == 'B') {
      TARGET_HEADING = 200.0 - 180;
      Serial.println("GOAL_COLOR:B");  //ç¢ºèªé€ä¿¡
    } else if (c == 'R') {
      TARGET_HEADING = 200.0 + 0.0;
      Serial.println("GOAL_COLOR:R");  //ç¢ºèªé€ä¿¡
    } else {
      Serial.print(F("Unexpected color code: "));
      Serial.println(c);
    }
  }
  
  // ========================================
  // ã‚³ãƒ³ãƒ‘ã‚¹ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  // ========================================
  Serial.println(F("--- Compass Calib ---"));
  waitForButtonPress();  // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
  calibrationCompassAdvanced();  // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆ15ç§’é–“å›è»¢ï¼‰
  Serial.println(F("Done!"));

  // ========================================
  // ğŸ’¡ NEW: Zè»¸ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  // ========================================
  /*
  Serial.println(F("--- Accel Z Calib ---"));
  Serial.println(F("Place robot on a level surface. Press button."));
  waitForButtonPress();  // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
  calibrateAccelZOffset();  // Zè»¸ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—
  Serial.println(F("Done! Z-Offset: "));
  Serial.println(ACCEL_Z_OFFSET);  // ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã‚’è¡¨ç¤º
  */

  // ========================================
  // ã‚«ãƒ©ãƒ¼ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  // ========================================
  Serial.println(F("--- Color Calib ---"));
  waitForButtonPress();  // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
  color_sensor.calibrate();  // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆ2ç§’é–“å‰é€²ï¼‰
  Serial.println(F("Done!"));

  // ========================================
  // å‹•ä½œé–‹å§‹
  // ========================================
  Serial.println(F("--- Start ---"));
  waitForButtonPress();  // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ

  // ãƒ­ãƒœãƒƒãƒˆã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–
  robot_state.mode = STATE_INIT;
  robot_state.time_now = robot_state.time_prev = millis();
  
  Serial.println(F("Running..."));

  // æ©Ÿä½“åã‚’é€ä¿¡ï¼ˆè¿½åŠ ï¼‰
  Serial.println("NAME:AAAA");

}

// ============================================
// ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
// ============================================
/**
 * ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
 * ã‚»ãƒ³ã‚µãƒ¼ã®èª­ã¿å–ã‚Šã¨ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œã‚’ç¹°ã‚Šè¿”ã™
 * ã“ã®é–¢æ•°ã¯æ°¸ç¶šçš„ã«å®Ÿè¡Œã•ã‚Œã‚‹
 */
void loop() {
  // ========================================
  // è‰²ã‚’è¨ˆæ¸¬ï¼ˆé »åº¦ã‚’ä¸‹ã’ã‚‹ï¼‰
  // ========================================
  // å‰å›è‰²ã‚’èª­ã¿å–ã£ãŸæ™‚åˆ»ã‚’è¨˜éŒ²
  static unsigned long lastColorRead = 0;
  
  // 100msçµŒéã—ã¦ã„ã‚Œã°è‰²ã‚’èª­ã¿å–ã‚‹
  if (millis() - lastColorRead > 100) {
    // å‰å›ã®è‰²ã‚’ä¿å­˜
    color_sensor.previous_color = color_sensor.current_color;
    
    // RGBå€¤ã‚’å–å¾—
    float r, g, b;
    color_sensor.getRGB(r, g, b);
    
    // è‰²ã‚’è­˜åˆ¥
    color_sensor.current_color = color_sensor.identifyColor((int)r, (int)g, (int)b);
    
    // æœ€å¾Œã«èª­ã¿å–ã£ãŸæ™‚åˆ»ã‚’æ›´æ–°
    lastColorRead = millis();
  }

  // ========================================
  // ãƒ‡ãƒãƒƒã‚°ï¼šåŠ é€Ÿåº¦Zè»¸ã®å€¤ã‚’è¡¨ç¤º
  // ========================================
  /*
  static unsigned long lastAccelDebug = 0;
  if (millis() - lastAccelDebug > 500) {
    compass_state.compass.readAcc();
    int accel_z = compass_state.compass.a.z + ACCEL_Z_OFFSET;
    Serial.print(F("ACCEL_Z:"));
    Serial.println(accel_z);
    lastAccelDebug = millis();
  }
  */

  // ========================================
  // ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œï¼ˆçŠ¶æ…‹é·ç§»ï¼‰
  // ========================================
  task();  // state_machine.inoã®task()ã‚’å‘¼ã³å‡ºã—
  
  // ========================================
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
  // ========================================
  printStatus();  // state_machine.inoã®printStatus()ã‚’å‘¼ã³å‡ºã—
}